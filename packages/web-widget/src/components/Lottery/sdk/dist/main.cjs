"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const r=require("@ton/core"),g=require("./factory-BWOFBbo4.js");var w=(t=>(t.Open="Open",t.Closed="Closed",t.Drawn="Drawn",t))(w||{});let p,T,v,h=0,C;async function y(){return p||(p=g.getFactoryInstance()),p}async function W(t){return T||(T=g.getRefWalletInstance(t)),T}async function m(t){if(!v||t!==h){const e=await(await y()).getLotteryAddress(BigInt(t));h=t,v=g.getLotteryInstance(e)}return v}function d(t){return C||(C=new g.TonConnectProvider(t)),C}function S(t){const n=t.toString().split("").reverse();return n.length===7&&n.pop(),n.join("").padStart(6,"0")}function $(t,n){let e=0;for(let a=0;a<6&&t[a]===n[a];a++)e++;return e}const B=async()=>{const t=await y();return Number(await t.getLotteryCnt())-1};function L(t){switch(t){case 0n:return w.Open;case 1n:return w.Closed;case 2n:return w.Drawn;default:throw new Error(`Unknown status: ${t}`)}}const A=async(t,n)=>{n===void 0&&(n=await B());const e={id:n,ticketsSold:0,drawTime:0,price:0,status:w.Open,claimable:!1,roundPot:"0",roundDraw:"",userData:{refReward:0,refWallet:null,tickets:[]}},[a,o]=await Promise.all([y(),m(n)]),s=r.address(t.account.address),[i,N,l,b,k]=await Promise.all([a.getReffererNumber(s).catch(()=>0),o.getAllTickets(),o.getInfo(),o.getWinningNumber(),o.getIsClaimable(s)]);if(Number(i)>0){const f=await a.getReferrerWalletAddress(s),c=await W(f);e.userData.refReward=Number(r.fromNano(await c.getBalance())),e.userData.refWallet=c.address}let u="";b>0&&(u=S(b));for(let f=0;f<N.size;f++){const c=N.get(BigInt(f)),D=S((c==null?void 0:c.number)??0);if(c==null?void 0:c.owner.equals(s)){const I=u?$(D,u):0,F={id:f,numbers:D,prizeAmount:I>0?Number(r.fromNano(await o.getCalculateRewardsForTicketId(BigInt(f)))):0,matched:I};e.userData.tickets.push(F)}}const R=Number(l.endTime)*1e3;return e.ticketsSold=Number(r.fromNano(l.ticketCnt)),e.drawTime=R,e.price=Number(r.fromNano(l.price)),e.status=L(l.status),e.roundPot=Number(r.fromNano(l.amountCollected)).toFixed(2),e.roundDraw=u,e.claimable=k,e},M=async t=>{const n=await y(),e=d(t);await n.send(e,{value:r.toNano("0.015")},"createRefWallet")},O=async t=>{const n=d(t);await(await y()).send(n,{value:r.toNano("0.02")},"withdraw_ref")},q=async(t,n)=>{const a=await(await m(t)).getCalculateTotalPriceForBulkTickets(BigInt(n));return Number(r.fromNano(a)).toFixed(2)},j=async(t,n,e,a,o)=>P(t,{roundIdx:n,qty:e,cost:a,refWallet:o}),z=async(t,n,e,a,o,s)=>P(t,{roundIdx:n,qty:e,cost:a,refWallet:s,recipient:o}),_=async(t,n,e)=>{const a=new g.TonConnectProvider(t);if(!a.address)return;const o=await m(n),s=r.Dictionary.empty();for(let i=0;i<e.length;i++)s.set(i,e[i]);await o.send(a,{value:r.toNano("0.02")*BigInt(e.length)},{$$type:"ClaimTickets",ticketIds:s,ticketLength:BigInt(e.length)})},E=async(t,n)=>{const e=await m(n),a=d(t);await e.send(a,{value:r.toNano("0.01")},"widrawCommission")},Q=async t=>{const n=d(t);if(!n.address)return;const e=Math.floor(Date.now()/1e3);await(await y()).send(n,{value:r.toNano("0.05")},{$$type:"CreateLottery",endTime:BigInt(e+3600*10),price:r.toNano("0.02"),discountDivisor:BigInt(400),creator:n.address})},U=async(t,n)=>{const e=await m(n),a=d(t);await e.send(a,{value:r.toNano("0.01")},"close")},G=async(t,n)=>{const e=await y(),a=d(t);await e.send(a,{value:r.toNano("0.04")},{$$type:"Draw",lotteryId:BigInt(n)})},H=async(t,n)=>{const e=d(t);await(await m(n)).send(e,{value:r.toNano("0.01")},"moveFunds")};async function P(t,n){const e=d(t);if(!e.address)return!1;const{roundIdx:a,qty:o,cost:s,refWallet:i=null,recipient:N=e.address}=n,l=r.Dictionary.empty();for(let u=0;u<o;u++){const R=1e6*Math.random();l.set(u,Number.parseInt(R.toString())+1e6)}const b=await m(a),k=BigInt(o);return await b.send(e,{value:r.toNano(s)+r.toNano("0.004")*k},{$$type:"BuyTicket",amount:k,ticketNumbers:l,recipient:N,refWallet:i}),!0}exports.RoundStatus=w;exports.buyTicket=j;exports.buyTicketFor=z;exports.claimPlatformComission=E;exports.claimReferralReward=O;exports.claimTickets=_;exports.closeRound=U;exports.createReferralWallet=M;exports.createRound=Q;exports.drawRound=G;exports.getLastRoundId=B;exports.getRound=A;exports.getTicketsPrice=q;exports.moveFunds=H;
//# sourceMappingURL=main.cjs.map
